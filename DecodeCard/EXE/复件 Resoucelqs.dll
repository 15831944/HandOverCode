--*syscfg增加 备注字段
if not exists(select * from syscolumns where id=object_id('SysCfg') and name='备注')
begin
alter table SysCfg add 备注 [varchar] (50)
end
GO
--升级SysCfg备注字段
UPDATE SysCfg SET 备注='闽AFQ380' where 备注 is NULL
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[CardTestN]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[CardTestN]
GO
--CardTestN 解码卡数据升级
CREATE PROCEDURE CardTestN  
WITH   ENCRYPTION 
AS
SET NOCOUNT ON --不返回计数
SELECT 准考证明编号,考车号,姓名 as MSG0,性别 as MSG1,流水号 as MSG2,身份证明编号 as MSG3,驾校名称 as MSG4,考试员1+'   '+(Select CONVERT(varchar(100), 预考日期, 23)) as MSG5,当日次数 as MSG6,考车号+'-'+SysCfg.备注+'-'+考试车型 as MSG7
FROM StudentInfo 
LEFT JOIN SchoolInfo ON 代理人=驾校编号 
JOIN SysCfg ON 考车号=项目
WHERE (Select CONVERT(varchar(100), 预考日期, 23)) = (Select CONVERT(varchar(100), GETDATE(), 23)) 
AND 登录状态='已登录' 
AND StudentInfo.状态='3' 
AND 路面读取='1'

/*--2016-08-02 ZSZ*/
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[pr_ErrorRecordALL]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[pr_ErrorRecordALL]
GO
--pr_ErrorRecordALL 解码卡数据升级
CREATE PROCEDURE pr_ErrorRecordALL
(
	@ZKZM_Number varchar(50)
) 
WITH   ENCRYPTION 
AS
SET NOCOUNT ON --不返回计数
SELECT e.记录编号,e.错误编号,CONVERT(varchar(10),e.出错时间,8) as 出错时间,ed.扣分类型,ed.扣除分数 FROM ErrorRecords e,StudentInfo s,ErrorData ed
WHERE e.准考证明编号=s.准考证明编号 
AND e.错误编号=ed.错误编号
AND e.考试次数=s.考试次数 
AND e.当日次数=s.当日次数 
AND e.准考证明编号=@ZKZM_Number
ORDER BY 记录编号 ASC
/*2014-07-08 ZSZ 参数:准考证明编号 */

GO

--创建pr_ErrorRecords 不存在的时候
if not exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[pr_ErrorRecords]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
begin
exec('CREATE PROCEDURE pr_ErrorRecords
(
	@ZKZM_Number varchar(50),--准考证明编号
	@Ejlbh bigint, --错误记录编号
	@intErrorCode int OUTPUT
) 
WITH   ENCRYPTION 
AS
BEGIN
SET NOCOUNT ON --不返回计数
set @intErrorCode=-1
return @intErrorCode
END
')
end
GO
--修改 pr_ErrorRecords 2014-10-09 加当日次数判断 
ALTER PROCEDURE pr_ErrorRecords
(
	@ZKZM_Number varchar(50),--准考证明编号
	@Ejlbh bigint, --错误记录编号
	@intErrorCode int OUTPUT
) 
WITH   ENCRYPTION 
AS
BEGIN
SET NOCOUNT ON --不返回计数
DECLARE @Status char(1)--状态
declare @KscsN tinyint --考试次数
declare @DrcsN tinyint --当日次数
declare @KSCJ int --成绩
declare @ErrorCode int --错误编号
declare @ErrorCodejl int --记录编号
SELECT @Status=状态,@KscsN=考试次数,@DrcsN=当日次数 FROM Studentinfo WHERE 准考证明编号=@ZKZM_Number
SELECT @KSCJ=100-SUM(扣除分数) FROM ErrorRecords JOIN ErrorData ON  ErrorRecords.错误编号=ErrorData.错误编号 
WHERE ErrorRecords.准考证明编号=@ZKZM_Number and 考试次数=@KscsN and 当日次数=@DrcsN

set @intErrorCode = 0
if exists(Select TOP 1 错误编号 from ErrorRecords where 准考证明编号=@ZKZM_Number and 记录编号>@Ejlbh and 当日次数=@DrcsN and 考试次数=@KscsN)
begin --1
Select TOP 1 @ErrorCode=错误编号,@ErrorCodejl=记录编号 from ErrorRecords where 准考证明编号=@ZKZM_Number and 记录编号>@Ejlbh and 当日次数=@DrcsN and 考试次数=@KscsN

if ((@ErrorCode>=301 and @ErrorCode<=309) OR (@ErrorCode>=401 and @ErrorCode<=409) OR (@ErrorCode>=501 and @ErrorCode<=509) OR (@ErrorCode>=601 and @ErrorCode<=609) OR (@ErrorCode>=701 and @ErrorCode<=709) OR @ErrorCode=249 OR @ErrorCode=259 )
begin --2
Select ErrorRecords.记录编号,ErrorRecords.错误编号,ErrorData.扣分类型
from ErrorRecords JOIN ErrorData ON ErrorRecords.错误编号=ErrorData.错误编号 
where ErrorRecords.记录编号=@ErrorCodejl

set @intErrorCode = 2
goto ERR_HANDLER
end --2
else if(@ErrorCode =399 OR @ErrorCode=499 OR @ErrorCode=599 OR @ErrorCode=699 OR @ErrorCode=799 OR @ErrorCode=899 OR @ErrorCode=999)
begin --3
Select ErrorRecords.记录编号,ErrorRecords.错误编号,ErrorData.扣分类型
from ErrorRecords JOIN ErrorData ON ErrorRecords.错误编号=ErrorData.错误编号 
where ErrorRecords.记录编号=@ErrorCodejl
set @intErrorCode = 5
goto ERR_HANDLER
end --3
else
begin --4
declare @counterrline int --统计错误行

SELECT @counterrline=Count(*) FROM ErrorRecords JOIN ErrorData ON  ErrorRecords.错误编号=ErrorData.错误编号 
WHERE ErrorRecords.准考证明编号=@ZKZM_Number and 考试次数=@KscsN and 当日次数=@DrcsN and ErrorData.扣除分数!=0 and ErrorRecords.记录编号<=@Ejlbh

Select ErrorRecords.记录编号,ErrorData.扣分类型,CONVERT(varchar(10),ErrorRecords.出错时间,8) as 出错时间,ErrorData.扣除分数,成绩=@KSCJ,ELine=@counterrline
from ErrorRecords JOIN ErrorData ON ErrorRecords.错误编号=ErrorData.错误编号 
where ErrorRecords.记录编号=@ErrorCodejl

set @intErrorCode = 3
goto ERR_HANDLER
end --4
end --1
else
begin --5
if(@Status =1 OR @Status =2)
BEGIN
	DECLARE @SXMStatus int
	select @SXMStatus=SUM(CounStart) from 
	(select case 
	when (错误编号>300 and 错误编号<320) then 1 
	when (错误编号>400 and 错误编号<420) then 2 
	when (错误编号>500 and 错误编号<520) then 4 
	when (错误编号>600 and 错误编号<620) then 8 
	when (错误编号>700 and 错误编号<720) then 16 
	when 错误编号=249 then 32 
	when 错误编号=259 then 64 
	else 0 end as CounStart from ErrorRecords
	where 准考证明编号=@ZKZM_Number and 考试次数=@KscsN and 当日次数=@DrcsN
	)TCE
	DECLARE @EXMStatus int	
	select @EXMStatus=SUM(CounEnd) from 
	(select case 
	when 错误编号=399 then 1 
	when 错误编号=499 then 2 
	when 错误编号=599 then 4 
	when 错误编号=699 then 8 
	when 错误编号=799 then 16 
	when 错误编号=899 then 32 
	when 错误编号=999 then 64 
	else 0 end as CounEnd,错误编号 from ErrorRecords
	where 准考证明编号=@ZKZM_Number and 考试次数=@KscsN and 当日次数=@DrcsN
	)TCE
	Select 状态=@Status,成绩=@KSCJ,S=@SXMStatus,E=@EXMStatus
	Set @intErrorCode =6
	goto ERR_HANDLER
END
else
BEGIN --6 zt!=1 or zt!=2
	Select 状态=@Status
	Set @intErrorCode=-1
END --6 zt!=1 or zt!=2
end	--5

ERR_HANDLER:
	return @intErrorCode
END
/*2014-09-15 ZSZ 参数:准考证明编号,误记录编号,返回值*/
GO
